name: ğŸ§¹ Cleanup Old Caches

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹å®šæ—¶è§¦å‘
  schedule:
    - cron: '0 3 * * 0'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # æ˜ç¡®ä¸ºè¿™ä¸ªä»»åŠ¡æˆäºˆåˆ é™¤ Actions ç¼“å­˜æ‰€éœ€çš„æƒé™
    permissions:
      actions: write

    steps:
      - name: ğŸ—‘ï¸ Delete old caches based on inactivity
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // --- é…ç½® ---
            // å®šä¹‰ç¼“å­˜çš„ä¿ç•™æœŸé™ï¼ˆå¤©ï¼‰ã€‚è¶…è¿‡è¿™ä¸ªå¤©æ•°æœªè¢«è®¿é—®çš„ç¼“å­˜å°†è¢«åˆ é™¤ã€‚
            const RETENTION_DAYS = 7; 
            // --- ç»“æŸé…ç½® ---

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const retentionDate = new Date();
            retentionDate.setDate(retentionDate.getDate() - RETENTION_DAYS);

            console.log(`ğŸ§¹ å‡†å¤‡æ¸…ç† ${owner}/${repo} ä¸­è¶…è¿‡ ${RETENTION_DAYS} å¤©æœªä½¿ç”¨çš„ç¼“å­˜...`);
            console.log(` older than ${retentionDate.toISOString()}`);

            // ä½¿ç”¨ github.paginate è‡ªåŠ¨å¤„ç†æ‰€æœ‰åˆ†é¡µ
            const caches = await github.paginate(github.rest.actions.getActionsCacheList, {
              owner: owner,
              repo: repo,
              per_page: 100,
            });

            const cachesToDelete = [];
            
            console.log(`ğŸ” æ€»å…±æ‰¾åˆ° ${caches.length} ä¸ªç¼“å­˜è¿›è¡Œæ£€æŸ¥ã€‚`);

            for (const cache of caches) {
              const lastAccessedAt = new Date(cache.last_accessed_at);
              if (lastAccessedAt < retentionDate) {
                console.log(`[DELETE] ç¼“å­˜ Key: ${cache.key}, å¤§å°: ${(cache.size_in_bytes / 1024 / 1024).toFixed(2)} MB, ä¸Šæ¬¡ä½¿ç”¨: ${cache.last_accessed_at}`);
                cachesToDelete.push(cache.id);
              } else {
                // ä¸ºäº†æ—¥å¿—æ¸…æ™°ï¼Œå¯ä»¥å–æ¶ˆä¸‹é¢è¿™è¡Œæ³¨é‡Šæ¥æŸ¥çœ‹è¢«ä¿ç•™çš„ç¼“å­˜
                // console.log(`[KEEP] ç¼“å­˜ Key: ${cache.key}, ä¸Šæ¬¡ä½¿ç”¨: ${cache.last_accessed_at}`);
              }
            }

            if (cachesToDelete.length === 0) {
              console.log("âœ… æ— å¯æ¸…ç†çš„æ—§ç¼“å­˜ã€‚");
              return;
            }

            console.log(`\nğŸ—‘ï¸ å°†è¦åˆ é™¤ ${cachesToDelete.length} ä¸ªæ—§ç¼“å­˜...`);

            let deletedCount = 0;
            for (const cache_id of cachesToDelete) {
              try {
                await github.rest.actions.deleteActionsCacheById({
                  owner: owner,
                  repo: repo,
                  cache_id: cache_id,
                });
                deletedCount++;
              } catch (error) {
                console.error(`åˆ é™¤ç¼“å­˜ ID ${cache_id} å¤±è´¥: ${error.message}`);
              }
            }
            
            console.log(`\nğŸ‰ æ¸…ç†å®Œæˆï¼æˆåŠŸåˆ é™¤äº† ${deletedCount} ä¸ªç¼“å­˜ã€‚`);

