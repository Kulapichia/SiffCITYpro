name: ğŸ§¹ Cleanup Old Caches

on:
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  # æ¯å‘¨æ—¥å‡Œæ™¨ 3 ç‚¹å®šæ—¶è§¦å‘
  schedule:
    - cron: '0 3 * * 0'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    # æ˜ç¡®ä¸ºè¿™ä¸ªä»»åŠ¡æˆäºˆåˆ é™¤ Actions ç¼“å­˜æ‰€éœ€çš„æƒé™
    permissions:
      actions: write

    steps:
      - name: ğŸ—‘ï¸ Delete old caches
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const caches = await github.rest.actions.getActionsCacheList({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100,
            });

            const mainBranchRef = 'refs/heads/main'; // ä½ çš„ä¸»åˆ†æ”¯
            let cachesToDelete = caches.data.actions_caches.filter(cache => !cache.key.includes(mainBranchRef));

            console.log(`æ€»å…±æ‰¾åˆ° ${caches.data.total_count} ä¸ªç¼“å­˜ã€‚`);
            console.log(`å°†è¦åˆ é™¤ ${cachesToDelete.length} ä¸ªéä¸»åˆ†æ”¯çš„ç¼“å­˜ã€‚`);

            for (const cache of cachesToDelete) {
              console.log(`æ­£åœ¨åˆ é™¤ç¼“å­˜ ID: ${cache.id}, Key: ${cache.key}`);
              await github.rest.actions.deleteActionsCacheById({
                owner: context.repo.owner,
                repo: context.repo.repo,
                cache_id: cache.id,
              });
            }
            console.log("æ¸…ç†å®Œæˆï¼");
