version: '3.8'

services:
  # 1. Nginx反向代理服务
  shihiütv-proxy:
    image: nginx:alpine
    container_name: shihiütv-proxy
    restart: unless-stopped
    volumes:
      # 挂载Nginx配置文件
      - ./shihiütv_nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - moontv-network
    depends_on:
      - shihiütv-core # 确保先启动应用再启动代理
    # 如果您需要从外部直接访问Nginx（例如用于调试或非隧道部署），
    # 请取消注释并将流量导入此端口。
    # ports:
    #   - "3080:80"

  # 2. Next.js应用核心服务
  shihiütv-core:
    image: hnctth/shihiütv:latest
    container_name: shihiütv-core
    restart: unless-stopped
    environment:
      - USERNAME=root
      - PASSWORD=xxxxxxxxx
      - NEXT_PUBLIC_STORAGE_TYPE=kvrocks
      - KVROCKS_URL=redis://moontv-kvrocks:6666
      - NEXT_PUBLIC_ENABLE_REGISTER=true
      - NEXT_PUBLIC_SITE_NAME=shihiütv
      - SITE_BASE=https://tv.xxxx.com
    networks:
      - moontv-network
    depends_on:
      - moontv-kvrocks
    # 注意：这里的端口是容器内部端口，不需要暴露给宿主机，
    # 因为所有流量都应该通过 shihiütv-proxy 代理。

  # 3. Kvrocks数据库服务
  moontv-kvrocks:
    image: apache/kvrocks
    container_name: moontv-kvrocks
    restart: unless-stopped
    volumes:
      - kvrocks-data:/var/lib/kvrocks # 使用我们定义的卷进行数据持久化
    networks:
      - moontv-network

  # 4. Cloudflare隧道服务
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared-shiyutv
    restart: unless-stopped
    networks:
      - moontv-network
    # 关键：让隧道指向Nginx代理服务，而不是直接指向应用核心
    # 如果用command参数配置，应类似如下:
    command: tunnel --no-autoupdate --url http://shihiütv-proxy:80 run --token eyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXNMSJ9

# 全局卷定义
volumes:
  kvrocks-data: {}

# 全局网络定义
networks:
  moontv-network:
    driver: bridge
