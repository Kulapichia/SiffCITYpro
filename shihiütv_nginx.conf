# 文件名: shihiütv_nginx.conf

# --- 关键修改 1 ---
# 将 log_format 的名字从 "main" 改为 "shihyu_log"，避免与 Nginx 默认配置冲突
log_format shihyu_log '$http_cf_connecting_ip - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent"';

server {
    listen 80;
    server_name _;

    # --- 关键修改 2 ---
    # 使用我们新定义的名字 "shihyu_log"
    access_log /var/log/nginx/access.log shihyu_log;
    error_log /var/log/nginx/error.log warn;

    # --- 规则 1: 处理 WebSocket 聊天请求 ---
    # 所有路径以 /ws 开头的请求，都转发到 shihiütv-core 容器的 3000 端口
    location /ws {
        # 关键：使用服务名 shihiütv-core 作为主机名，Docker DNS 会解析到正确的容器 IP
        # 简化 proxy_pass，Nginx会自动传递路径和参数
        proxy_pass http://shihiütv-core:3000;
        # WebSocket 升级连接所必需的头部信息
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # 传递客户端的真实信息
        proxy_set_header Host $host;
        # Cloudflare 会通过 CF-Connecting-IP 传递真实客户端 IP
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
        # 隧道外面是 HTTPS，需要明确告知后端应用
        proxy_set_header X-Forwarded-Proto https;
        # WebSocket 需要长连接和低延迟
        proxy_buffering off;
        proxy_read_timeout 7d; # 延长超时时间以保持连接
    }

    # --- 规则 2: 处理所有其他网页和 API 请求 ---
    # 其他所有请求，都转发到 shihiütv-core 容器的 3000 端口 (Next.js 服务)
    location / {
        proxy_pass http://shihiütv-core:3000;
        # 为主路径添加WebSocket头，兼容Next.js热更新等功能
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        # 传递客户端的真实信息
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-For $http_cf_connecting_ip;
        proxy_set_header X-Forwarded-Proto https;
    }
}
