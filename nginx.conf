pid /etc/nginx/logs/nginx.pid;
error_log /usr/local/src/nginx/nginx-1.26.0/logs/error.log;

http {
    # WebSocket 连接升级支持
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }
    
    # 设置最大上传文件大小为 100MB
    client_max_body_size 100M;

    # 默认 SSL 配置
    ssl_certificate /opt/siffcity.pem;
    ssl_certificate_key /opt/siffcity.key;
    
    # 日志设置
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$upstream_cache_status" '
                      '$request_time $upstream_response_time $pipe';
    access_log  /etc/nginx/logs/access.log  main;
   # 反向代理缓存设置
   proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=chhsai_cache:10m max_size=10g inactive=60m use_temp_path=off;

    # 强制 HTTP 到 HTTPS 重定向
    server {
        listen 80;
        listen [::]:80;
        server_name siffcity.sbs aki.siffcity.sbs new.siffcity.sbs ai.siffcity.sbs chat.siffcity.sbs aci.siffcity.sbs ari.siffcity.sbs api.siffcity.sbs tr.siffcity.sbs;
        
        # 重定向所有 HTTP 请求到 HTTPS
        return 301 https://$host$request_uri;
    }

    # ai.siffcity.sbs -> 本机3000端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name ai.siffcity.sbs;

        # CORS 头部设置
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:3000;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }
    

    
    # siffcity.sbs -> 本机3005端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:3005;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }

    # api.siffcity.sbs -> 本机3005端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name api.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:3005;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }
    

    
    # web.siffcity.sbs -> 本机3210端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name web.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:3210;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }

    # ccr.siffcity.sbs -> 本机3456端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name ccr.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:3456;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }

    # oi.siffcity.sbs -> 本机3990端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name oi.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:3990;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            # 关键修复
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }

    # aki.siffcity.sbs -> 本机8000端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name aki.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:8000;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }


    # dia.siffcity.sbs -> 本机3999端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name dia.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:3999;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }
    

         
        
    # chat.siffcity.sbs -> 本机6050端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name chat.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:6050;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }
            

    
    # ari.siffcity.sbs -> 本机8759端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name ari.siffcity.sbs;
	   # 启用压缩
	   gzip on;
	   gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:8759;
	       proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Upgrade $http_upgrade;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }






    # claude35.siffcity.sbs -> 本机8697端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name claude35.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:8697;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
        location = /logout {
            return 301 https://claude35.siffcity.sbs/;
        }    
    }


	# aci.siffcity.sbs -> 本机3323端口
	server {
	    listen 443 ssl;
	    listen [::]:443 ssl;
	    http2 on;
	    server_name aci.siffcity.sbs;
	
	    # 增强的 CORS 和安全头信息
	    add_header 'Access-Control-Allow-Origin' '*' always;
	    add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
	    add_header 'Access-Control-Allow-Headers' '*' always;
	    add_header 'Access-Control-Allow-Credentials' 'true' always;
	    add_header 'Access-Control-Max-Age' '3600' always;
	    
	    # 处理预检请求
	    if ($request_method = 'OPTIONS') {
	        return 204;
	    }
	
	    location / {
	        # 现有的代理设置
	        proxy_http_version 1.1;
	        proxy_pass http://127.0.0.1:3323;
	        
	        # 额外的头信息
	        proxy_set_header Connection "";
	        proxy_set_header Host $http_host;
	        proxy_set_header X-Forwarded-Proto $scheme;
	        proxy_set_header X-Real-IP $remote_addr;
	        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	        
	        # 额外的安全头信息
	        proxy_set_header X-Requested-With XMLHttpRequest;
	        proxy_set_header Origin $http_origin;
	        
	        # 现有的超时设置
	        proxy_buffering off;
	        proxy_cache off;
	        send_timeout 600;
	        proxy_connect_timeout 600;
	        proxy_send_timeout 600;
	        proxy_read_timeout 600;
	    }
	}

    
   
      


    # trans.siffcity.sbs -> 本机38888端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name trans.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:38888;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }
    




    # tr.siffcity.sbs -> deeplx translate	
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name tr.siffcity.sbs;


        # CORS 头部设置
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;        

        location / {
            proxy_http_version 1.1;
            proxy_ssl_server_name on;
            proxy_ssl_name api.deeplx.org;
            proxy_ssl_verify off;
            proxy_pass https://api.deeplx.org/WILWeoSKQ0A3mQw0qkqhndbVodnaAIBtlQO6dAEa2ok/translate;
            proxy_set_header Host api.deeplx.org;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header Accept-Encoding "";

            # 反向代理缓存配置
            proxy_cache chhsai_cache;
            proxy_cache_valid 200 302 60m;
            proxy_cache_valid 404 1m;
            proxy_cache_key "$scheme$proxy_host$request_uri";
            proxy_ignore_headers Cache-Control Expires Set-Cookie;
            proxy_hide_header Set-Cookie;

            # 超时设置
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }

    # claude.siffcity.sbs -> claude3.5	
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name claude.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:8181;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            proxy_buffer_size 256k;
            proxy_buffers 8 256k;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }

    # tv.siffcity.sbs -> 本机3133端口
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name tv.siffcity.sbs;
        
        # CORS 头部设置
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        # --- 为 Next.js 静态资源添加专用路由 ---
        # 匹配所有 /_next/ 路径下的静态资源请求
        location /_next {
            proxy_pass http://127.0.0.1:3133;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 关键：只对成功的响应（状态码 200）进行缓存
            # 这样可以避免缓存重定向（3xx）或错误页面（4xx, 5xx）
            proxy_cache_valid 200 365d; 
            
            # 明确告诉Nginx哪些响应不要缓存
            proxy_no_cache $http_pragma $http_authorization;
            proxy_cache_bypass $http_pragma $http_authorization;

            # 如果后端响应中包含 Cache-Control: private/no-cache/no-store，则不缓存
            proxy_ignore_headers Cache-Control;
            
            # 重新启用缓存头，但只对成功的请求
            if ($upstream_status = 200) {
                add_header Cache-Control "public, max-age=31536000, immutable" always;
            }
        }

        # --- 为WebSocket聊天功能添加专用路由 ---
        # 所有 /ws-api 开头的请求都转发到 3001 端口 (独立的WebSocket服务)
        location /ws-api {
            proxy_pass http://127.0.0.1:3001; # <--- 指向独立的WebSocket服务端口
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket 需要长连接和实时性，因此禁用缓冲
            proxy_buffering off;
            proxy_cache off;
            proxy_request_buffering off;
            
            # 延长超时时间以维持长连接
            proxy_connect_timeout 7d;
            proxy_send_timeout 7d;
            proxy_read_timeout 7d;
            
            # 健康检查和重试策略
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
        }

        # --- 为普通网页和API请求配置路由 ---
        # 其他所有请求都转发到 3133 端口
        location / {
            proxy_pass http://127.0.0.1:3133; # <--- 您指定的应用主服务端口
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade; # 兼容Next.js开发模式热更新
            proxy_set_header Connection $connection_upgrade;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;


            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }


    # aai.siffcity.sbs -> claude3.5	
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name aai.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:5000;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }
    # proxy.siffcity.sbs -> proxy
    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        http2 on;
        server_name proxy.siffcity.sbs;

        # CORS 头部设置
        # add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization, X-Requested-With' always;

        location / {
            proxy_http_version 1.1;
            proxy_pass http://127.0.0.1:5006;
            proxy_set_header Connection "";
            proxy_set_header Host $http_host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_buffering off;
            proxy_cache off;
            send_timeout 600;
            proxy_connect_timeout 600;
            proxy_send_timeout 600;
            proxy_read_timeout 600;
        }
    }


       
}

events {
    worker_connections 1024;
}
