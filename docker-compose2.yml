version: '3.8'
services:

  shihiütv-core:
    image: devinglaw/siffcitypro:pr-1
    container_name: shihiütv-core
    restart: unless-stopped
    ports:
      - '3133:3000' # Next.js 应用端口
    dns:
      - 8.8.8.8
      - 8.8.4.4
    dns_search:
      - .
    dns_opt:
      - ndots:1
    environment:
      - USERNAME=root
      - PASSWORD=XXXXXXXXX
      - NEXT_PUBLIC_STORAGE_TYPE=kvrocks
      - KVROCKS_URL=redis://shihiütv-kvrocks:6666
      - NEXT_PUBLIC_ENABLE_REGISTER=true
      - NEXT_PUBLIC_SITE_NAME=shihiütv
    networks:
      - shihiütv-network
    depends_on:
      - shihiütv-kvrocks
    volumes:
      - ./gai.conf:/etc/gai.conf:ro 

  # 新增：专门用于运行WebSocket的服务
  shihiütv-ws:
    image: devinglaw/siffcitypro:pr-1 # 使用与核心服务相同的镜像
    container_name: shihiütv-ws
    restart: unless-stopped
    # 关键：覆盖默认启动命令，转而执行独立的WebSocket服务器脚本
    command: node standalone-websocket.js
    ports:
      - '3134:3001' # 关键：将独立的WebSocket服务端口暴露给主机
    environment:
      - USERNAME=root
      - PASSWORD=XXXXXXXXX
      - NEXT_PUBLIC_STORAGE_TYPE=kvrocks
      - KVROCKS_URL=redis://shihiütv-kvrocks:6666
      - WS_PORT=3001 # 明确指定内部端口
    networks:
      - shihiütv-network
    depends_on:
      - shihiütv-kvrocks

  shihiütv-kvrocks:
    image: apache/kvrocks
    container_name: shihiütv-kvrocks
    restart: unless-stopped
    volumes:
      - kvrocks-data:/var/lib/kvrocks
    networks:
      - shihiütv-network

  watchtower:
    image: containrrr/watchtower
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - WATCHTOWER_POLL_INTERVAL=300
    command: ""

# 全局卷定义
volumes:
  kvrocks-data: {}

# 全局网络定义 (修正原始文件中的网络名称不匹配问题)
networks:
  shihiütv-network:
    driver: bridge
